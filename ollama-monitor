#!/bin/bash
#
# ollama-monitor - Real-time Ollama monitoring for macOS
# https://github.com/tobiasoberrauch/ollama-monitor
#

VERSION="1.0.0"
INTERVAL=${1:-1}
OLLAMA_URL="${OLLAMA_HOST:-http://localhost:11434}"

# Colors
R='\033[0;31m'    # Red
G='\033[0;32m'    # Green
Y='\033[1;33m'    # Yellow
B='\033[0;34m'    # Blue
C='\033[0;36m'    # Cyan
W='\033[1;37m'    # White bold
D='\033[0;90m'    # Dim
N='\033[0m'       # Reset

# Show help
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "ollama-monitor v${VERSION}"
    echo ""
    echo "Usage: ollama-monitor [interval]"
    echo ""
    echo "Options:"
    echo "  interval    Refresh interval in seconds (default: 1)"
    echo "  -h, --help  Show this help"
    echo "  -v          Show version"
    echo ""
    echo "Environment:"
    echo "  OLLAMA_HOST  Ollama API URL (default: http://localhost:11434)"
    exit 0
fi

if [[ "$1" == "-v" || "$1" == "--version" ]]; then
    echo "ollama-monitor v${VERSION}"
    exit 0
fi

# Cleanup on exit
cleanup() {
    printf '\033[?25h'  # Show cursor
    stty echo 2>/dev/null
    echo ""
    exit 0
}
trap cleanup EXIT INT TERM

# Progress bar generator
bar() {
    local pct=$1 len=${2:-20} filled empty color
    filled=$((pct * len / 100))
    [[ $filled -gt $len ]] && filled=$len
    [[ $filled -lt 0 ]] && filled=0
    empty=$((len - filled))

    [[ $pct -gt 80 ]] && color=$R || { [[ $pct -gt 50 ]] && color=$Y || color=$G; }

    printf "${color}%${filled}s${D}%${empty}s${N}" | tr ' ' 'â–ª' | tr ' ' 'Â·'
}

# Main monitor loop
monitor() {
    printf '\033[?25l'      # Hide cursor
    printf '\033[2J'        # Clear once
    stty -echo 2>/dev/null

    while true; do
        printf '\033[H'     # Home cursor

        # Header
        printf "${C}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${N}\033[K\n"
        printf "${C}â”‚${N}  ${W}ðŸ¦™ OLLAMA MONITOR${N}                    ${D}v${VERSION}${N}  ${C}â”‚${N}\033[K\n"
        printf "${C}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤${N}\033[K\n"

        # Check connection
        if ! curl -s "$OLLAMA_URL/api/tags" &>/dev/null; then
            printf "${C}â”‚${N}  ${R}â— Offline${N} - Ollama nicht erreichbar            ${C}â”‚${N}\033[K\n"
            printf "${C}â”‚${N}    ${D}ollama serve${N}                                  ${C}â”‚${N}\033[K\n"
            printf "${C}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${N}\033[K\n"
            printf '\033[J'
            sleep $INTERVAL
            continue
        fi

        # Get data
        local ps_data=$(curl -s "$OLLAMA_URL/api/ps" 2>/dev/null)
        local model_name=$(echo "$ps_data" | jq -r '.models[0]?.name // empty' 2>/dev/null)
        local model_vram=$(echo "$ps_data" | jq -r '.models[0]?.size_vram // 0' 2>/dev/null)

        # Status line
        if [[ -n "$model_name" ]]; then
            local vram_gb=$(echo "scale=1; $model_vram / 1073741824" | bc)
            printf "${C}â”‚${N}  ${G}â—${N} ${W}%-28s${N} ${D}%6sGB${N}  ${C}â”‚${N}\033[K\n" "${model_name:0:28}" "$vram_gb"
        else
            printf "${C}â”‚${N}  ${D}â—‹ Kein Model geladen${N}                           ${C}â”‚${N}\033[K\n"
        fi

        printf "${C}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤${N}\033[K\n"

        # Process stats
        local pid=$(pgrep -x ollama 2>/dev/null | head -1)
        if [[ -n "$pid" ]]; then
            local stats=$(ps -p $pid -o %cpu,%mem,rss 2>/dev/null | tail -1)
            local cpu=$(echo $stats | awk '{printf "%.0f", $1}')
            local mem_pct=$(echo $stats | awk '{print $2}')
            local rss=$(echo $stats | awk '{print $3}')
            local rss_gb=$(echo "scale=1; $rss / 1048576" | bc 2>/dev/null)

            # Status indicator
            local status_icon status_text
            if [[ ${cpu:-0} -gt 50 ]]; then
                status_icon="${G}â–¶${N}" status_text="Verarbeitet"
            elif [[ ${cpu:-0} -gt 5 ]]; then
                status_icon="${Y}â–¶${N}" status_text="Aktiv"
            else
                status_icon="${B}â– ${N}" status_text="Idle"
            fi

            printf "${C}â”‚${N}  CPU   $(bar ${cpu:-0} 16)  %3d%%  ${status_icon} %-10s${C}â”‚${N}\033[K\n" "${cpu:-0}" "$status_text"
            printf "${C}â”‚${N}  RAM   ${W}%5sGB${N}  ${D}(%s%% System)${N}                 ${C}â”‚${N}\033[K\n" "$rss_gb" "$mem_pct"
        fi

        # System memory
        local mem_free=$(memory_pressure 2>/dev/null | grep "System-wide memory free" | awk '{print $5}' | tr -d '%')
        if [[ -n "$mem_free" ]]; then
            local mem_used=$((100 - mem_free))
            printf "${C}â”‚${N}  Mem   $(bar $mem_used 16)  %3d%%              ${C}â”‚${N}\033[K\n" "$mem_used"
        fi

        printf "${C}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤${N}\033[K\n"

        # Models list (compact)
        printf "${C}â”‚${N}  ${D}Models:${N}                                          ${C}â”‚${N}\033[K\n"
        curl -s "$OLLAMA_URL/api/tags" 2>/dev/null | jq -r '
            .models[:5][] |
            "  \(.name | .[0:24]) \(.details.parameter_size // "-" | .[0:6]) \(.size/1073741824 | .*10|floor/10)G"
        ' 2>/dev/null | while read line; do
            printf "${C}â”‚${N} ${D}%-51s${N}${C}â”‚${N}\033[K\n" "$line"
        done

        printf "${C}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${N}\033[K\n"
        printf "${D}  $(date '+%H:%M:%S') â”‚ Refresh: ${INTERVAL}s â”‚ Ctrl+C exit${N}\033[K\n"

        printf '\033[J'  # Clear below
        sleep $INTERVAL
    done
}

monitor
